---
title: "TEOS Hydrostation S Data Lab"
author: "Jose Martinez"
date: "2023-03-07"
output: html_document
  #prettydoc::html_pretty:
    #theme: architect
   #highlight: github
---

## Load required libraries
```{r message = FALSE, warning = FALSE}
library(prettydoc)
library(tidyverse)
library(gsw)
library(readr)
library(plotly)
```

## Now we need to import our data
```{r message = FALSE, warning = FALSE}
hydrostation_bottle <- read_delim("hydrostation_bottle.txt", 
    delim = "\t", escape_double = FALSE, 
    col_names = FALSE, trim_ws = TRUE, skip = 31)

hydrostation_bottle_names <- read_csv("hydrostation_bottle.txt", 
    skip = 30)

colnames(hydrostation_bottle) = colnames(hydrostation_bottle_names)
#view(hydrostation_bottle)
```

## Hydrostation S Discrete Bottle Data for years 1955 through December 2020.

### Variable Names and Units

- yyyymmdd = Year Month Day   
- decy   = Decimal Year     
- time   = Time (hhmm)      
- latN   = Latitude (Deg N) 
- lonW   = Longitude (Deg W)
- Depth  = Depth (m)                  
-Temp   = Temperature ITS-90 (C) 
- Pres   = CTD Pressure (dbar)   
- CTD_S  = CTD Salinity (PSS-78)      
- Sal1   = Salinity-1 (PSS-78)        
- Sig-th = Sigma-Theta (kg/m^3)       
- O2(1)  = Oxygen-1 (umol/kg)          
- OxFixT = Oxygen Fix Temp (C)        
- Anom1  = Oxy Anomaly-1 (umol/kg)    
Quality flags
- -999  = No data
- 0 = Less than detection limit
```{r}
# lets first plot the data
hydrostation_bottle %>% 
  filter(`Sig-th`!= -999) %>% # filter out -999 no data flag
  ggplot()+geom_point(aes(x=decy, y = `Sig-th`)) # hard to interpret even w no -999s

hydrostation_bottle %>% 
  filter(`Sig-th`!= -999 & Depth <20) %>% # filter out -999 no data flag and by upper 20m
  ggplot()+geom_line(aes(x=decy, y = `Sig-th`)) # line shows seasonality 
# clear seasonal signal for sigma-theta, lets see how this compares to temp
hydrostation_bottle %>% 
  filter(`Sig-th`!= -999 & Depth <20) %>% # filter out -999 no data flag and by upper 20m
  ggplot()+geom_point(aes(x=Temp, y = `Sig-th`))
```


## TEOS-10 Toolbox in Package Seacarb

```{r}
?gsw #launches documentation for gibbs seawater toolbox
? gsw_sigma0 # lets check this function 
# it says we need absolute salinity and conservative temperature

#first we need absolute salinity

?gsw_SA_from_SP
#practical salinity
#sea pressure(dbar)
#longitude
#latitude

#plot our pressure data - its missing before 1980s
hydrostation_bottle %>% 
  ggplot()+geom_point(aes(x=decy,y=Pres))

#we have depth for the time series
hydrostation_bottle %>% 
  ggplot()+
  geom_point(aes(x=decy, y=Depth))

#adds a pressure column from depth and latN columns from/to hydrostation bottle
hydrostation_bottle = 
  hydrostation_bottle %>% 
  mutate(Pres_gsw = gsw_p_from_z(Depth*-1,latN,))

hydrostation_bottle %>% 
  ggplot()+geom_point(aes(x=Pres,y=Pres_gsw))
# we see strong 1:1 agreement between measured pressure and calculated pressure

hydrostation_bottle %>% 
  ggplot()+geom_point(aes(x=decy,y=latN))

hydrostation_bottle = 
  hydrostation_bottle %>% 
  mutate(Pres_gsw = gsw_p_from_z(Depth*-1,latN,)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN))
#plot it
hydrostation_bottle %>% 
  filter(Sal1!=-999) %>% 
  ggplot()+
  geom_point(aes(x=Sal1,y=S_abs_gsw))
# now we need to calculate conservative temperature
# we need absolute salinity, insitu temp (ITS-90), and sea pressure
hydroS =
  hydrostation_bottle %>% 
  filter(Sal1!=-999) %>%
  mutate(Pres_gsw = gsw_p_from_z(Depth*-1,latN,)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN)) %>% 
  mutate(T_cons_gsw = gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw))

hydroS %>% 
  filter(Temp!= -999) %>% 
  ggplot()+
  geom_point(aes(x=Temp, y =T_cons_gsw))

#add line to calculate conservative temperature
hydroS =
  hydrostation_bottle %>% 
  filter(Sal1!=-999) %>%
  mutate(Pres_gsw = gsw_p_from_z(Depth*-1,latN,)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN)) %>% 
  mutate(T_cons_gsw = gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw)) %>% 
  mutate(Sig_th_gsw = gsw_sigma0(S_abs_gsw,T_cons_gsw))

hydroS %>% 
  filter(`Sig-th`!= -999) %>% 
  ggplot()+
  geom_point(aes(x=`Sig-th`, y=Sig_th_gsw))

hydroS %>% 
  filter(Sig_th_gsw<0)
  #view()


# how to replace data in a line without making this many dataframes (i.e. select and/or filters)
hydroS_correctedS_a =
  hydroS %>% 
  filter(Sig_th_gsw<0) %>%
  mutate(S_abs_gsw=gsw_SA_from_SP(CTD_S,Pres_gsw,360-lonW,latN)) %>% 
  mutate(T_cons_gsw = gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw)) %>% 
  mutate(Sig_th_gsw = gsw_sigma0(S_abs_gsw,T_cons_gsw)) 


hydroS_correctedS_b =
  hydroS %>% 
  filter(Sig_th_gsw>0)

hydroS_corrected = rbind(hydroS_correctedS_a, hydroS_correctedS_b) 


hydroS_corrected %>% 
  filter(`Sig-th`!= -999) %>% 
  ggplot()+
  geom_point(aes(x=`Sig-th`, y=Sig_th_gsw))

## Next day
hydroS_corrected %>% 
  ggplot()+
  geom_point(aes(x=Sig_th_gsw, y = Depth))+
  scale_y_reverse()+
  scale_x_continuous(position ="top")+
  xlab(expression(paste(sigma[theta]," (kg m"^"-3",")")))+
  ylab("Depth(m)")

```





# Has surface sigma theta decreased over time?

```{r}
hydroS_shallow = hydroS_corrected %>% 
  filter(Depth<30)

sig_theta_tm = lm(Sig_th_gsw~decy,data =  hydroS_shallow) # y (Sig) is a function of x(decy), lm(y~x,data = data )
summary(sig_theta_tm)


plot = hydroS_shallow %>% 
  ggplot()+
  geom_point(aes(x=decy, y=Sig_th_gsw))+
  geom_line(aes(x=decy, y=Sig_th_gsw))+
  geom_smooth(aes(x=decy, y=Sig_th_gsw),method = "lm")+
  theme_classic()
ggplotly(plot)

#y=mx + b

#y = Sig_th_gsw
#x - decy
#coeffiecients: intercept = b, decy = m
#Sig_th_gsw = -0004*decy + 33.4
```


#Lab Assignment
1. Pick a question (include hypothesis)

How does oxygen look like at depth and over time? 
H1 : Oxygen reaches a min in the upper 1000m before increasing with further depth

2. Produce a plot and statistical summary using lm()
```{r}


o2_h = hydroS_corrected %>% 
  filter(`O2(1)`!= -999) %>% 
  filter(Depth < 50)
  #mutate(month = substr(yyyymmd,5,6))
 #mutate(month=as.numeric(substr(yyyymmd,5,6))) %>% 
  #mutate(season =ifelse(month==12|month==1|month==2|month==3,'winter',ifelse(month==8|month==9|month==10,'summer',''))) # adds seasons to data

o2_h %>% 
  ggplot()+
  geom_point(aes(x=`O2(1)`,y = Depth))+
  xlab('Oxygen (µmol/kg)')+
  ylab('Depth (m)')+
  scale_y_reverse()+
  scale_x_continuous(position ="top")
o2_h
```

3. Describe your results, the summary, and answer the question
4. Compile into a completed lab report using R markdown

Potential Questions :
  
  How do temperature, salinity, and sigma-theta co-vary?
  Is there a relationship betwen sigma-theta and oxygen?
  Is there a relationship of any of the parameters with depth? With time?  Within a depth range over time?
  Are there seasonal differences in any of the parameters?
```{r}
o2_ht = 
  hydroS_corrected %>% 
  filter(Sal1!= -999) %>% 
  filter(Sal1 > 2) %>% # broken electrode on salinity measuring device
  filter(`O2(1)`!= -999) %>% 
  filter(Depth < 50)
 
plot_1 = o2_ht %>% 
  ggplot()+
  geom_point(aes(x = `O2(1)`,y=Sal1))+
  xlab('Oxygen (µmol/kg)')+
  ylab('Salinity')+
  geom_smooth(aes(x=`O2(1)`, y=Sal1,),method = "lm")

plot_1




plot_2 = o2_ht %>% 
  ggplot()+
  geom_point(aes(x=decy,y = `O2(1)`))+
  ylab('Oxygen (µmol/kg)')+
  xlab('Time')+
  geom_smooth(aes(x=decy, y=`O2(1)`),method = "lm")

plot_2

oxygen_time = lm(`O2(1)`~decy,data =  o2_ht) # y (Sig) is a function of x(decy), lm(y~x,data = data )
summary(oxygen_time)

oxygen_sal = lm(`O2(1)`~Sal1,data =  o2_ht) # y (Sig) is a function of x(decy), lm(y~x,data = data )
summary(oxygen_sal)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
